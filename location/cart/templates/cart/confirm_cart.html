{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 md:p-6">

    <!-- Titre résumé -->
    <h2 class="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-[#B08824] via-[#5B6E9D] to-[#7F5DB0]">
        Résumé et paiement
    </h2>

    <!-- Informations client -->
    <div class="bg-white shadow p-4 rounded-lg space-y-3">
        <p><strong>Nom & Prénom :</strong> {{ user.get_full_name }}</p>
        <p><strong>Email :</strong> {{ user.email }}</p>
        <p><strong>Adresse :</strong> {{ user.profile.address }}</p>
        <p><strong>Heure de livraison / installation :</strong> {{ delivery_time }}</p>

        <!-- Dates et détails des items -->
        <div>
            <p><strong>Détails et dates des photobooths loués :</strong></p>
            <ul class="list-disc ml-5">
                {% for item in cart.items.all %}
                    <li>
                        {{ item.photobooth.name }}
                        {% if item.option %} - {{ item.option.name }}{% endif %} 
                        (Qté : {{ item.quantite }})<br>
                        <strong>Date :</strong> {{ item.start_date|date:"d/m/Y" }} → {{ item.end_date|date:"d/m/Y" }}
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Total à payer -->
    <p class="text-3xl font-extrabold mt-4 text-transparent bg-clip-text bg-gradient-to-r from-[#B08824] via-[#5B6E9D] to-[#7F5DB0]">
        Total à payer : {{ total_price|floatformat:2 }} €
    </p>

    <!-- Bouton Stripe -->
    <form id="payment-form" class="mt-6 text-right">
        {% csrf_token %}
        <button type="submit" class="bg-white text-[#5B6E9D] font-semibold px-6 py-2 rounded shadow hover:bg-gray-100 transition-colors">
            Payer avec Stripe
        </button>
    </form>

</div>

<!-- Script Stripe -->
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");

document.getElementById("payment-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const payButton = e.target.querySelector('button[type="submit"]');
    payButton.disabled = true;
    payButton.textContent = 'Traitement du paiement...';

    try {
        const response = await fetch("{% url 'create_checkout_session' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok && data.id) { 
            stripe.redirectToCheckout({ sessionId: data.id });
        } else {
            alert(data.error || "Erreur : impossible de créer la session Stripe.");
            console.error("Erreur Django/Stripe:", data.error || "Données de réponse inattendues:", data);
        }
    } catch (error) {
        console.error("Erreur lors de la création de la session Stripe:", error);
        alert("Une erreur est survenue lors de la communication avec le serveur. Veuillez réessayer.");
    } finally {
        payButton.disabled = false;
        payButton.textContent = 'Payer avec Stripe';
    }
});
</script>
{% endblock %}
