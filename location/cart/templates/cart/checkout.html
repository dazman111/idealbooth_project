{% load i18n %}
<h2>{% trans "Paiement" %}</h2>
<button id="checkout-button">{% trans "Payer avec Stripe" %}</button>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<!-- üîê CSRF via cookie -->
<script>
  // R√©cup√®re le CSRF token depuis le cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
</script>

<!-- üí≥ Script Stripe -->
<script>
  const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");

  document.getElementById("checkout-button").addEventListener("click", function () {
    fetch("{% url 'create_checkout_session' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      credentials: "include", // obligatoire pour que les cookies soient envoy√©s
    })
    .then(response => response.json())
    .then(session => {
      if (session.id) {
        return stripe.redirectToCheckout({ sessionId: session.id });
      } else {
        alert('Erreur : ' + (session.error || 'Impossible de cr√©er la session.'));
      }
    })
    .catch(error => {
      console.error("Erreur lors de la cr√©ation de la session Stripe :", error);
      alert("Erreur lors de la redirection vers Stripe.");
    });
  });
</script>
